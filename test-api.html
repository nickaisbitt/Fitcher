<!DOCTYPE html>
<html>
<head>
  <title>Kraken API Test</title>
  <style>
    body { font-family: monospace; background: #1a1a2e; color: #0f0; padding: 20px; }
    .success { color: #0f0; }
    .error { color: #f00; }
    .info { color: #0ff; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    #log { background: #000; padding: 10px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>ðŸ”§ Kraken API Connection Test</h1>
  <p>Click buttons to test different connection methods:</p>

  <button onclick="testDirect()">1. Test Direct API</button>
  <button onclick="testAllOrigins()">2. Test AllOrigins Proxy</button>
  <button onclick="testCorsProxy()">3. Test CorsProxy.io</button>
  <button onclick="testWebSocket()">4. Test WebSocket</button>
  <button onclick="clearLog()">Clear Log</button>

  <div id="log"></div>

  <script>
    function log(msg, type = 'info') {
      const div = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      div.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
      div.scrollTop = div.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function testDirect() {
      log('Testing DIRECT connection to api.kraken.com...', 'info');
      try {
        const response = await fetch('https://api.kraken.com/0/public/Ticker?pair=XXBTZUSD');
        const data = await response.json();
        if (data.result) {
          const price = data.result.XXBTZUSD.c[0];
          log(`âœ“ DIRECT works! BTC price: $${price}`, 'success');
        } else {
          log('âœ— DIRECT failed: ' + JSON.stringify(data.error), 'error');
        }
      } catch (e) {
        log('âœ— DIRECT failed: ' + e.message, 'error');
      }
    }

    async function testAllOrigins() {
      log('Testing ALLORIGINS proxy...', 'info');
      try {
        const url = encodeURIComponent('https://api.kraken.com/0/public/Ticker?pair=XXBTZUSD');
        const response = await fetch(`https://api.allorigins.win/raw?url=${url}`);
        const data = await response.json();
        if (data.result) {
          const price = data.result.XXBTZUSD.c[0];
          log(`âœ“ ALLORIGINS works! BTC price: $${price}`, 'success');
        } else {
          log('âœ— ALLORIGINS failed: ' + JSON.stringify(data.error), 'error');
        }
      } catch (e) {
        log('âœ— ALLORIGINS failed: ' + e.message, 'error');
      }
    }

    async function testCorsProxy() {
      log('Testing CORSPROXY.IO...', 'info');
      try {
        const url = encodeURIComponent('https://api.kraken.com/0/public/Ticker?pair=XXBTZUSD');
        const response = await fetch(`https://corsproxy.io/?${url}`);
        const data = await response.json();
        if (data.result) {
          const price = data.result.XXBTZUSD.c[0];
          log(`âœ“ CORSPROXY works! BTC price: $${price}`, 'success');
        } else {
          log('âœ— CORSPROXY failed: ' + JSON.stringify(data.error), 'error');
        }
      } catch (e) {
        log('âœ— CORSPROXY failed: ' + e.message, 'error');
      }
    }

    function testWebSocket() {
      log('Testing WEBSOCKET connection to wss://ws.kraken.com...', 'info');
      try {
        const ws = new WebSocket('wss://ws.kraken.com');

        ws.onopen = () => {
          log('âœ“ WebSocket CONNECTED!', 'success');
          ws.send(JSON.stringify({
            event: 'subscribe',
            pair: ['XBT/USD'],
            subscription: { name: 'ticker' }
          }));
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (Array.isArray(data) && data[2] === 'ticker') {
            const price = data[1].c[0];
            log(`WebSocket price update: BTC = $${price}`, 'success');
            ws.close();
          } else if (data.event) {
            log(`WebSocket event: ${data.event}`, 'info');
          }
        };

        ws.onerror = (e) => {
          log('âœ— WebSocket ERROR: ' + e.message, 'error');
        };

        ws.onclose = () => {
          log('WebSocket closed', 'info');
        };

        setTimeout(() => {
          if (ws.readyState !== WebSocket.CLOSED) {
            ws.close();
            log('WebSocket test timeout (5s)', 'info');
          }
        }, 5000);

      } catch (e) {
        log('âœ— WebSocket failed: ' + e.message, 'error');
      }
    }

    log('Ready to test. Click a button above.', 'info');
  </script>
</body>
</html>
